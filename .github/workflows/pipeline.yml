name: Pinnacle Pipeline

on:
  schedule:
    # 13:00 UTC - Pipeline completo COM download do historico
    # (CSV e atualizado ~meio-dia, entao baixamos logo apos)
    - cron: '0 13 * * *'
    # 10:00 e 22:00 UTC - Pipeline SEM download do historico
    # (usa dados em cache, so coleta odds + value bets)
    - cron: '0 10,22 * * *'
  workflow_dispatch:
    # Permite execucao manual com opcoes
    inputs:
      skip_history:
        description: 'Pular etapa 1 (dados historicos)'
        required: false
        type: boolean
        default: false
      only_step:
        description: 'Rodar apenas etapa N (deixe vazio para todas)'
        required: false
        type: choice
        options:
          - ''
          - '1'
          - '2'
          - '3'
          - '4'

jobs:
  pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # ------------------------------------------------------------------
      # Setup
      # ------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      # ------------------------------------------------------------------
      # Restore cached data from previous runs
      # ------------------------------------------------------------------
      - name: Restore databases from cache
        uses: actions/cache@v4
        with:
          path: |
            pinnacle_data.db
            bets_tracker/bets.db
            bets_tracker/user_bets.db
            database_improved/lol_history.db
            database_improved/data_transformed.csv
            database_improved/ligas_times.json
            database_improved/database.csv
          key: pinnacle-data-${{ github.run_number }}
          restore-keys: |
            pinnacle-data-

      # ------------------------------------------------------------------
      # Determine if this is the history-download run (13:00 UTC)
      # ------------------------------------------------------------------
      - name: Check if history download run
        id: check_schedule
        run: |
          HOUR=$(date -u +%H)
          if [ "$HOUR" = "13" ]; then
            echo "skip_history=false" >> $GITHUB_OUTPUT
            echo "Pipeline completo COM download do historico (13:00 UTC)"
          else
            echo "skip_history=true" >> $GITHUB_OUTPUT
            echo "Pipeline SEM download do historico ($HOUR:00 UTC)"
          fi

      # ------------------------------------------------------------------
      # Run the pipeline
      # ------------------------------------------------------------------

      # Schedule: 13:00 UTC - pipeline completo com historico
      - name: Run full pipeline (with history download)
        if: >-
          github.event_name == 'schedule'
          && steps.check_schedule.outputs.skip_history == 'false'
        env:
          PINNACLE_SIG: ${{ secrets.PINNACLE_SIG }}
          PINNACLE_APT: ${{ secrets.PINNACLE_APT }}
          PINNACLE_PCTAG: ${{ secrets.PINNACLE_PCTAG }}
          PINNACLE_API_KEY: ${{ secrets.PINNACLE_API_KEY }}
          PINNACLE_DEVICE_UUID: ${{ secrets.PINNACLE_DEVICE_UUID }}
          PINNACLE_DIRECTUS_TOKEN: ${{ secrets.PINNACLE_DIRECTUS_TOKEN }}
          PINNACLE_DPVXZ: ${{ secrets.PINNACLE_DPVXZ }}
          PINNACLE_EV_MIN_STORE: ${{ secrets.PINNACLE_EV_MIN_STORE }}
          PINNACLE_EV_MIN_APP: ${{ secrets.PINNACLE_EV_MIN_APP }}
        run: python run_all.py

      # Schedule: 10:00 / 22:00 UTC - pipeline sem historico
      - name: Run pipeline (skip history, use cache)
        if: >-
          github.event_name == 'schedule'
          && steps.check_schedule.outputs.skip_history == 'true'
        env:
          PINNACLE_SIG: ${{ secrets.PINNACLE_SIG }}
          PINNACLE_APT: ${{ secrets.PINNACLE_APT }}
          PINNACLE_PCTAG: ${{ secrets.PINNACLE_PCTAG }}
          PINNACLE_API_KEY: ${{ secrets.PINNACLE_API_KEY }}
          PINNACLE_DEVICE_UUID: ${{ secrets.PINNACLE_DEVICE_UUID }}
          PINNACLE_DIRECTUS_TOKEN: ${{ secrets.PINNACLE_DIRECTUS_TOKEN }}
          PINNACLE_DPVXZ: ${{ secrets.PINNACLE_DPVXZ }}
          PINNACLE_EV_MIN_STORE: ${{ secrets.PINNACLE_EV_MIN_STORE }}
          PINNACLE_EV_MIN_APP: ${{ secrets.PINNACLE_EV_MIN_APP }}
        run: python run_all.py --skip-history

      # Manual: pipeline completo
      - name: Run full pipeline (manual)
        if: >-
          github.event_name == 'workflow_dispatch'
          && github.event.inputs.only_step == ''
          && github.event.inputs.skip_history == 'false'
        env:
          PINNACLE_SIG: ${{ secrets.PINNACLE_SIG }}
          PINNACLE_APT: ${{ secrets.PINNACLE_APT }}
          PINNACLE_PCTAG: ${{ secrets.PINNACLE_PCTAG }}
          PINNACLE_API_KEY: ${{ secrets.PINNACLE_API_KEY }}
          PINNACLE_DEVICE_UUID: ${{ secrets.PINNACLE_DEVICE_UUID }}
          PINNACLE_DIRECTUS_TOKEN: ${{ secrets.PINNACLE_DIRECTUS_TOKEN }}
          PINNACLE_DPVXZ: ${{ secrets.PINNACLE_DPVXZ }}
          PINNACLE_EV_MIN_STORE: ${{ secrets.PINNACLE_EV_MIN_STORE }}
          PINNACLE_EV_MIN_APP: ${{ secrets.PINNACLE_EV_MIN_APP }}
        run: python run_all.py

      # Manual: skip history
      - name: Run pipeline without history (manual)
        if: >-
          github.event_name == 'workflow_dispatch'
          && github.event.inputs.only_step == ''
          && github.event.inputs.skip_history == 'true'
        env:
          PINNACLE_SIG: ${{ secrets.PINNACLE_SIG }}
          PINNACLE_APT: ${{ secrets.PINNACLE_APT }}
          PINNACLE_PCTAG: ${{ secrets.PINNACLE_PCTAG }}
          PINNACLE_API_KEY: ${{ secrets.PINNACLE_API_KEY }}
          PINNACLE_DEVICE_UUID: ${{ secrets.PINNACLE_DEVICE_UUID }}
          PINNACLE_DIRECTUS_TOKEN: ${{ secrets.PINNACLE_DIRECTUS_TOKEN }}
          PINNACLE_DPVXZ: ${{ secrets.PINNACLE_DPVXZ }}
          PINNACLE_EV_MIN_STORE: ${{ secrets.PINNACLE_EV_MIN_STORE }}
          PINNACLE_EV_MIN_APP: ${{ secrets.PINNACLE_EV_MIN_APP }}
        run: python run_all.py --skip-history

      # Manual: etapa especifica
      - name: Run single step (manual)
        if: >-
          github.event_name == 'workflow_dispatch'
          && github.event.inputs.only_step != ''
        env:
          PINNACLE_SIG: ${{ secrets.PINNACLE_SIG }}
          PINNACLE_APT: ${{ secrets.PINNACLE_APT }}
          PINNACLE_PCTAG: ${{ secrets.PINNACLE_PCTAG }}
          PINNACLE_API_KEY: ${{ secrets.PINNACLE_API_KEY }}
          PINNACLE_DEVICE_UUID: ${{ secrets.PINNACLE_DEVICE_UUID }}
          PINNACLE_DIRECTUS_TOKEN: ${{ secrets.PINNACLE_DIRECTUS_TOKEN }}
          PINNACLE_DPVXZ: ${{ secrets.PINNACLE_DPVXZ }}
          PINNACLE_EV_MIN_STORE: ${{ secrets.PINNACLE_EV_MIN_STORE }}
          PINNACLE_EV_MIN_APP: ${{ secrets.PINNACLE_EV_MIN_APP }}
        run: python run_all.py --only ${{ github.event.inputs.only_step }}

      # ------------------------------------------------------------------
      # Upload artifacts (backup / inspection)
      # ------------------------------------------------------------------
      - name: Upload databases as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pinnacle-databases-${{ github.run_number }}
          path: |
            pinnacle_data.db
            bets_tracker/bets.db
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload historical data as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pinnacle-history-${{ github.run_number }}
          path: |
            database_improved/lol_history.db
            database_improved/data_transformed.csv
            database_improved/ligas_times.json
          retention-days: 14
          if-no-files-found: ignore

      # ------------------------------------------------------------------
      # Summary
      # ------------------------------------------------------------------
      - name: Pipeline summary
        if: always()
        run: |
          echo "## Pipeline Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Run:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **History download:** ${{ steps.check_schedule.outputs.skip_history == 'false' && 'Yes' || 'No (cached)' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Database files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f pinnacle_data.db ]; then
            echo "- pinnacle_data.db: $(du -h pinnacle_data.db | cut -f1)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- pinnacle_data.db: not found" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f bets_tracker/bets.db ]; then
            echo "- bets_tracker/bets.db: $(du -h bets_tracker/bets.db | cut -f1)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- bets_tracker/bets.db: not found" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f database_improved/lol_history.db ]; then
            echo "- database_improved/lol_history.db: $(du -h database_improved/lol_history.db | cut -f1)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- database_improved/lol_history.db: not found" >> $GITHUB_STEP_SUMMARY
          fi
