name: Pinnacle Pipeline

on:
  schedule:
    # Roda 3x ao dia: 10:00, 16:00, 22:00 UTC
    # Ajustar conforme horarios dos jogos de LoL
    - cron: '0 10,16,22 * * *'
  workflow_dispatch:
    # Permite execucao manual com opcoes
    inputs:
      skip_history:
        description: 'Pular etapa 1 (dados historicos)'
        required: false
        type: boolean
        default: false
      only_step:
        description: 'Rodar apenas etapa N (deixe vazio para todas)'
        required: false
        type: choice
        options:
          - ''
          - '1'
          - '2'
          - '3'
          - '4'

jobs:
  pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # ------------------------------------------------------------------
      # Setup
      # ------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      # ------------------------------------------------------------------
      # Restore cached data from previous runs
      # ------------------------------------------------------------------
      - name: Restore databases from cache
        uses: actions/cache@v4
        with:
          path: |
            pinnacle_data.db
            bets_tracker/bets.db
            bets_tracker/user_bets.db
            database_improved/lol_history.db
            database_improved/data_transformed.csv
            database_improved/ligas_times.json
            database_improved/database.csv
          key: pinnacle-data-${{ github.run_number }}
          restore-keys: |
            pinnacle-data-

      # ------------------------------------------------------------------
      # Run the pipeline
      # ------------------------------------------------------------------
      - name: Run full pipeline
        if: ${{ github.event_name == 'schedule' || (github.event.inputs.only_step == '' && github.event.inputs.skip_history == 'false') }}
        env:
          PINNACLE_SIG: ${{ secrets.PINNACLE_SIG }}
          PINNACLE_APT: ${{ secrets.PINNACLE_APT }}
          PINNACLE_PCTAG: ${{ secrets.PINNACLE_PCTAG }}
          PINNACLE_API_KEY: ${{ secrets.PINNACLE_API_KEY }}
          PINNACLE_DEVICE_UUID: ${{ secrets.PINNACLE_DEVICE_UUID }}
          PINNACLE_DIRECTUS_TOKEN: ${{ secrets.PINNACLE_DIRECTUS_TOKEN }}
          PINNACLE_DPVXZ: ${{ secrets.PINNACLE_DPVXZ }}
          PINNACLE_EV_MIN_STORE: ${{ secrets.PINNACLE_EV_MIN_STORE }}
          PINNACLE_EV_MIN_APP: ${{ secrets.PINNACLE_EV_MIN_APP }}
        run: python run_all.py

      - name: Run pipeline (skip history)
        if: ${{ github.event.inputs.skip_history == 'true' && github.event.inputs.only_step == '' }}
        env:
          PINNACLE_SIG: ${{ secrets.PINNACLE_SIG }}
          PINNACLE_APT: ${{ secrets.PINNACLE_APT }}
          PINNACLE_PCTAG: ${{ secrets.PINNACLE_PCTAG }}
          PINNACLE_API_KEY: ${{ secrets.PINNACLE_API_KEY }}
          PINNACLE_DEVICE_UUID: ${{ secrets.PINNACLE_DEVICE_UUID }}
          PINNACLE_DIRECTUS_TOKEN: ${{ secrets.PINNACLE_DIRECTUS_TOKEN }}
          PINNACLE_DPVXZ: ${{ secrets.PINNACLE_DPVXZ }}
          PINNACLE_EV_MIN_STORE: ${{ secrets.PINNACLE_EV_MIN_STORE }}
          PINNACLE_EV_MIN_APP: ${{ secrets.PINNACLE_EV_MIN_APP }}
        run: python run_all.py --skip-history

      - name: Run single step
        if: ${{ github.event.inputs.only_step != '' }}
        env:
          PINNACLE_SIG: ${{ secrets.PINNACLE_SIG }}
          PINNACLE_APT: ${{ secrets.PINNACLE_APT }}
          PINNACLE_PCTAG: ${{ secrets.PINNACLE_PCTAG }}
          PINNACLE_API_KEY: ${{ secrets.PINNACLE_API_KEY }}
          PINNACLE_DEVICE_UUID: ${{ secrets.PINNACLE_DEVICE_UUID }}
          PINNACLE_DIRECTUS_TOKEN: ${{ secrets.PINNACLE_DIRECTUS_TOKEN }}
          PINNACLE_DPVXZ: ${{ secrets.PINNACLE_DPVXZ }}
          PINNACLE_EV_MIN_STORE: ${{ secrets.PINNACLE_EV_MIN_STORE }}
          PINNACLE_EV_MIN_APP: ${{ secrets.PINNACLE_EV_MIN_APP }}
        run: python run_all.py --only ${{ github.event.inputs.only_step }}

      # ------------------------------------------------------------------
      # Upload artifacts (backup / inspection)
      # ------------------------------------------------------------------
      - name: Upload databases as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pinnacle-databases-${{ github.run_number }}
          path: |
            pinnacle_data.db
            bets_tracker/bets.db
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload historical data as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pinnacle-history-${{ github.run_number }}
          path: |
            database_improved/lol_history.db
            database_improved/data_transformed.csv
            database_improved/ligas_times.json
          retention-days: 14
          if-no-files-found: ignore

      # ------------------------------------------------------------------
      # Summary
      # ------------------------------------------------------------------
      - name: Pipeline summary
        if: always()
        run: |
          echo "## Pipeline Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Run:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Database files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f pinnacle_data.db ]; then
            echo "- pinnacle_data.db: $(du -h pinnacle_data.db | cut -f1)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- pinnacle_data.db: not found" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f bets_tracker/bets.db ]; then
            echo "- bets_tracker/bets.db: $(du -h bets_tracker/bets.db | cut -f1)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- bets_tracker/bets.db: not found" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f database_improved/lol_history.db ]; then
            echo "- database_improved/lol_history.db: $(du -h database_improved/lol_history.db | cut -f1)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- database_improved/lol_history.db: not found" >> $GITHUB_STEP_SUMMARY
          fi
